opt_out_usage

def root_path
  Dir.pwd.sub(/.*\Kfastlane/, '').sub(/.*\Kandroid/, '').sub(/.*\Kios/, '').sub(/.*\K\/\//, '')
end

lane :sh_on_root do |options|
  command = options[:command]
  sh("cd #{root_path} && #{command}")
end

lane :clean do
  sh_on_root(command: "flutter clean")
end

lane :fetch_dependencies do
  sh_on_root(command: "flutter pub get --suppress-analytics")
end

lane :build_autogenerated_code do
  sh_on_root(command: "flutter gen-l10n && flutter pub run build_runner build --delete-conflicting-outputs")
end

# lane :lint do
#   sh_on_root(command: "flutter format --set-exit-if-changed -n lib test")
# end

# lane :test do |options|
#   sh_on_root(command: "flutter test --no-pub --coverage --suppress-analytics")
# end

lane :analyze do |options|
  sh_on_root(command: "flutter analyze")
end

lane :verify do
  clean
  fetch_dependencies
  build_autogenerated_code
  #lint
  # test
end

lane :build do |options|
    sh_on_root(command: "flutter build #{options[:type]} --release --build-number=#{options[:buildNumber]} --suppress-analytics --flavor #{options[:flavor]} -t #{options[:main]} --obfuscate --split-debug-info=build/app/outputs/symbols")
end